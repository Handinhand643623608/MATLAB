function ai_xcorrEI(fileStruct, paramStruct)

%% Initialize
% Assign inputs
assignInputs(fileStruct.analysis.xcorr.EEG_IC, 'createOnly')
assignInputs(paramStruct.xcorr.EEG_IC, 'createOnly')

% Initialize function-specific parameters
components = paramStruct.ICA.componentIdents;
visibleFigs = visibleFigs;

% Initialize the folder structure for saving images
masterSaveDir = [savePathImage '\' saveID];
for i = 1:length(components)
    inPath = [masterSaveDir '\' components{i}];
    firstLevel = {...
        'Mean Images', [];...
        'Mean Thresholded Images', [];...
        'Subject', subjects};
    secondLevel = {'Scan', 'Subject', scans};
    folderStruct.(components{i}) = createNestedFolders(...
        'inPath', inPath,...
        'firstLevel', firstLevel,...
        'secondLevel', secondLevel);
end

% Initialize parallel processing
if parallelSwitch && matlabpool('size') == 0
    matlabpool
elseif ~parallelSwitch && matlabpool('size') ~= 0
    matlabpool close
end
    

%% Image the Raw Cross-Correlation Data
if singleSubjectFlag    
    % Load the raw cross-correlation data
    corrLoadStr = ['corrData_EEG_IC_' saveTag '_' saveID '.mat'];
    load(corrLoadStr)

    % Initialize section-specific parameters
    if ~exist('imageShifts', 'var')
        imageShifts = corrData(1, 1).info.shiftsTime;
    end
    shiftsTimeAll = corrData(1, 1).info.shiftsTime;

    progressbar('Raw Correlation Image Generation', 'Scans Completed', 'Components Completed')
    for i = subjects
        progressbar([], 0, [])
        for j = scans{i}
            currentChannels = corrData(i, j).info.channels;

            progressbar([], [], 0)
            for k = 1:length(components)
                % Get the data to be imaged
                currentCorr = corrData(i, j).data.(components{k});

                switch parallelSwitch
                    case true
                        parfor L = 1:length(imageShifts)
                            m = k*i + L;
                            % Produce the images
                            idxShiftsTime = find(shiftsTimeAll == imageShifts(L));
                            u_colormap_EEG(currentCorr(:, idxShiftsTime), currentChannels, [-0.5 0.5]);
                            set(gcf, 'Visible', visibleFigs)
                            currentTitleStr = sprintf('Subject %d Scan %d EEG-%s Raw Cross-Correlation (%d s Time Shift)', i, j, components{k}, -imageShifts(L));
                            title(currentTitleStr)

                            % Save in the appropriate folder
                            currentSavePath = folderStruct.(components{k}).Subject.(num2word(i)).Scan.(num2word(j));
                            currentSaveName = sprintf('%04d', m);
                            currentSaveStr = [currentSavePath '\' currentSaveName '.png'];
                            saveas(gcf, currentSaveStr, 'png')
                            close
                        end
                        
                    otherwise
                        m = 1;
                        for L = 1:length(imageShifts)
                            % Produce the images
                            idxShiftsTime = find(shiftsTimeAll == imageShifts(L));
                            u_colormap_EEG(currentCorr(:, idxShiftsTime), currentChannels, [-0.5 0.5]);
                            set(gcf, 'Visible', visibleFigs)
                            currentTitleStr = sprintf('Subject %d Scan %d EEG-%s Raw Cross-Correlation (%d s Time Shift)', i, j, components{k}, -imageShifts(L));
                            title(currentTitleStr)

                            % Save in the appropriate folder
                            currentSavePath = folderStruct.(components{k}).Subject.(num2word(i)).Scan.(num2word(j));
                            currentSaveName = sprintf('%04d', m);
                            currentSaveStr = [currentSavePath '\' currentSaveName '.png'];
                            saveas(gcf, currentSaveStr, 'png')
                                m = m + 1;
                            close
                        end
                end
                progressbar([], [], k/length(components))
            end
            progressbar([], j/length(scans{i}), [])
        end
        progressbar(find(subjects == i)/length(subjects), [], [])
    end

    % Garbage collect
    clear corrData current*
    
end


%% Image the Raw Mean & Thresholded Mean Cross-Correlation Data
% Load the mean cross-correlation data
meanLoadStr = ['meanCorrData_EEG_IC_' saveTag '_' saveID '.mat'];
load(meanLoadStr);

% Initialize section-specific variables
if exist('imageShifts', 'var')
    imageShifts = imageShifts;
else
    imageShifts = meanCorrData.info.shiftsTime;
end
shiftsTimeAll = meanCorrData.info.shiftsTime;

progressbar('Component Correlations Imaged')
for i = 1:length(components)
    % Get the correlation data to be imaged
    currentCorr = meanCorrData.data.(components{i});
    currentChannels = meanCorrData.info.channels;
    currentCutoffs =  meanCorrData.info.cutoffs.(components{i});
    
    switch parallelSwitch
        case true
            parfor j = 1:length(imageShifts)
                % Setup an image index for saving
                m = j;

                % Get the thresholded correlation data to be imaged
                currentThreshCorr = currentCorr;
                currentThreshCorr(currentThreshCorr >= currentCutoffs(1) & currentThreshCorr <= currentCutoffs(2)) = 0;

                % Produce images of raw average cross-correlation
                idxShiftsTime = find(shiftsTimeAll == imageShifts(j));
                u_colormap_EEG(currentCorr(:, idxShiftsTime), currentChannels, [-0.2 0.2]);
                set(gcf, 'Visible', visibleFigs)
                currentTitleStr = sprintf('EEG-%s Average Cross-Correlation (%d s Time Shift)', components{i}, -imageShifts(j));
                title(currentTitleStr)

                % Save in the appropriate folder
                currentSavePath = folderStruct.(components{i}).MeanImages.root;
                currentSaveName = sprintf('%04d', m);
                currentSaveStr = [currentSavePath '\' currentSaveName '.png'];
                saveas(gcf, currentSaveStr, 'png')
                close

                % Produce images of thresholded average cross-correlation
                u_colormap_EEG(currentThreshCorr(:, idxShiftsTime), currentChannels, [-0.2 0.2]);
                set(gcf, 'Visible', visibleFigs)
                currentTitleStr = sprintf('EEG-%s Thresholded Average Cross-Correlation (%d s Time Shift)', components{i}, -imageShifts(j));
                title(currentTitleStr)

                % Save in the appropriate older
                currentSavePath = folderStruct.(components{i}).MeanThresholdedImages.root;
                currentSaveName = sprintf('%04d', m);            
                currentSaveStr = [currentSavePath '\' currentSaveName '.png'];
                saveas(gcf, currentSaveStr, 'png')
                close
            end
            
        otherwise
            for j = 1:length(imageShifts)
                % Setup an image index for saving
                m = j;

                % Get the thresholded correlation data to be imaged
                currentThreshCorr = currentCorr;
                currentThreshCorr(currentThreshCorr >= currentCutoffs(1) & currentThreshCorr <= currentCutoffs(2)) = 0;

                % Produce images of raw average cross-correlation
                idxShiftsTime = find(shiftsTimeAll == imageShifts(j));
                u_colormap_EEG(currentCorr(:, idxShiftsTime), currentChannels, [-0.2 0.2]);
                set(gcf, 'Visible', visibleFigs)
                currentTitleStr = sprintf('EEG-%s Average Cross-Correlation (%d s Time Shift)', components{i}, -imageShifts(j));
                title(currentTitleStr)

                % Save in the appropriate folder
                currentSavePath = folderStruct.(components{i}).MeanImages.root;
                currentSaveName = sprintf('%04d', m);
                currentSaveStr = [currentSavePath '\' currentSaveName '.png'];
                saveas(gcf, currentSaveStr, 'png')
                close

                % Produce images of thresholded average cross-correlation
                u_colormap_EEG(currentThreshCorr(:, idxShiftsTime), currentChannels, [-0.2 0.2]);
                set(gcf, 'Visible', visibleFigs)
                currentTitleStr = sprintf('EEG-%s Thresholded Average Cross-Correlation (%d s Time Shift)', components{i}, -imageShifts(j));
                title(currentTitleStr)

                % Save in the appropriate older
                currentSavePath = folderStruct.(components{i}).MeanThresholdedImages.root;
                currentSaveName = sprintf('%04d', m);            
                currentSaveStr = [currentSavePath '\' currentSaveName '.png'];
                saveas(gcf, currentSaveStr, 'png')
                close
            end
    end
    progressbar(i/length(components))
end

% Garbage collect
clear current* meanCorrData

if matlabpool('size') ~= 0
    matlabpool close
end